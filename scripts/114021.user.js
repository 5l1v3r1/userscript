// ==UserScript==// @name           UpUp.us Birthdays// @description    Description// @namespace      http://kol.upup.us/scripts/// @include        http://*kingdomofloathing.com/lchat.php*// @include        http://*kingdomofloathing.com/showplayer.php?who=*// @include		   http://*127.0.0.1:6008*lchat.php*// @include		   http://*127.0.0.1:6008*showplayer.php?who=*// ==/UserScript==if(!GM_getValue('lastBirthdayUpdate',false)) {	var currentTime = parseInt(new Date().getTime()/60000);	GM_setValue('lastBirthdayUpdate',currentTime);}if(!GM_getValue('forceCleared',false)) {	GM_setValue('storedBirthdays','({})');	GM_setValue('forceCleared',true);}var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var lmonths = ["January","February","March","April","May","June","July","August","September","October","November","December"];var birthdays;var todaysBirthdays;var todaysBirthdayIds;var dateString;var cssStyle = (<r><![CDATA[a[birthday=true],td.birthday {	padding-right:12px;	background-image: url(data:image/gif;base64,R0lGODlhCAAKAIABAAAAAP%2F%2F%2FyH5BAEAAAEALAAAAAAIAAoAAAISTGBoy%2BmrIph0tmOR1gcrVoUFADs%3D);	background-repeat: no-repeat;	background-position: center right;	background-attachment: scroll;}.todaysBirthdays b {	display:block;	text-align:center;}]]></r>).toString();GM_addStyle(cssStyle);switch (document.location.pathname) {	case "/lchat.php":		unstoreBirthdays(chatBirthdays);	break;	case "/showplayer.php":		unstoreBirthdays(profileBirthdays);	break;}function showTodaysBirthdays() {	if(todaysBirthdays.length) {		var bdayContainer = document.createElement('div');		bdayContainer.className = "todaysBirthdays tiny";				var bold = document.createElement('b');		bold.appendChild(document.createTextNode("Today's Player Birthdays:"));		bdayContainer.appendChild(bold);				for(var i=0,l=todaysBirthdays.length;i<l;i++) {			if(i>0)bdayContainer.appendChild(document.createTextNode(', '));			var id=todaysBirthdays[i][0];			var name=todaysBirthdays[i][1];						var link = document.createElement('a');			link.setAttribute('birthday',false);			link.target="mainpane";			link.href="showplayer.php?who="+id;						//this is stupid but supports other scripts through consistency			var font=document.createElement('font');			font.color="black";			font.appendChild(document.createTextNode(name));			link.appendChild(font);			bdayContainer.appendChild(link);		}		bdayContainer.appendChild(document.createTextNode(" ("+todaysBirthdays.length+" total)"));		document.getElementById('ChatWindow').appendChild(bdayContainer);	}}function unstoreBirthdays(callback) {	birthdays = new Object();	storedBirthdays = eval(GM_getValue('storedBirthdays','({})'));	dataLength=0;	var forceUpdate=false;	for(var i in storedBirthdays){dataLength++;}		var currentTime = parseInt(new Date().getTime()/60000);	var lastUpdate=GM_getValue('lastBirthdayUpdate',0);			if(dataLength==0||currentTime-lastUpdate > 2880) {		//no current data		getBirthdays(returnBirthdays);	} else {		returnBirthdays(true);	}	function returnBirthdays(skip) {		if(!skip) {			storedBirthdays = eval(GM_getValue('storedBirthdays','({})'));		}		birthdays = storedBirthdays;		if( typeof callback=='function' ){			callback();					}	}}function getBirthdays(callback) {	GM_get("noblesse-oblige.org/calendar/birthdays_by_day.txt",parseData,true);	function parseData(datatxt) {	//fix data		var birthdays = new Object();			datatxt = datatxt.replace(/ \(#/g,'\t').replace(/\)/g,'');		datatxt = datatxt.replace(/: /g,'\t');						//split by line		var a=datatxt.split('\n');		for(var i=0,l=a.length;i<l;i++){			var b=a[i];			var split = b.split('\t');			if(!birthdays[split[0]]) birthdays[split[0]]=new Array();			birthdays[split[0]].push([split[2],split[1]]);		}		GM_setValue('storedBirthdays',birthdays.toSource());		GM_setValue('lastBirthdayUpdate',parseInt(new Date().getTime()/60000));		if( typeof callback=='function' ){			callback();		}	}}function profileBirthdays() {	var playerId = /who=(\d+)/.exec(document.location.search);	if(playerId)playerId=playerId[1];		var thisDate;	for (var a in birthdays) {		for(var i=0,l=birthdays[a].length;i<l;i++) {			if(birthdays[a][i][0]==playerId) {			thisDate=a;			break;			}		}	}	if(!thisDate)return;		var d=new Date();	var monthName = months[d.getMonth()];	dateString = monthName+' '+d.getDate();	var stringDiff = "";	var birthdayToday = false;		var birthdayDate = new Date(thisDate+" "+(d.getFullYear()));	if(dateString==thisDate) {		stringDiff = "Today!";		birthdayToday=true;	} else {			if(birthdayDate<d) {			birthdayDate.setYear(birthdayDate.getFullYear()+1);		}				var diff = birthdayDate-d.getTime();		var minutes = 60000;		var hours = minutes*60;		var days = hours*24;				var dayDiff = Math.floor(diff/days);		if(dayDiff<1) {			var hourDiff = Math.floor(diff/hours);			if(hourDiff<1) {				var minuteDiff = Math.floor(diff/minutes);				stringDiff =minuteDiff+" minutes left";			} else {				stringDiff = hourDiff+" hours left";			}		} else {			stringDiff = dayDiff+" days left";		}		}	var dayString =((day=birthdayDate.getDate())<10)?"0"+day:day;	var birthdayDateString = lmonths[birthdayDate.getMonth()]+" "+dayString;	var accountCreated = find(".//b[.='Account Created:']/ancestor::tr[1]");	if(accountCreated) {		var row = accountCreated.cloneNode(true);		row.title = stringDiff;		if(birthdayToday)row.getElementsByTagName('td')[1].className+=" birthday";		row.style.cursor = "help";		row.getElementsByTagName('b')[0].firstChild.nodeValue = "Birthday:";		row.getElementsByTagName('td')[1].firstChild.nodeValue = birthdayDateString;		accountCreated.parentNode.insertBefore(row,accountCreated);	}}function find(xp,location) {	if(!location)location = document;	var temp = document.evaluate(xp, location, null, XPathResult.FIRST_ORDERED_NODE_TYPE,null);	return temp.singleNodeValue;}function submitFormRedirect(e) {	if(e.target == submitButton) {		var theForm = document.getElementsByTagName('form')[0];		var grafString = theForm.elements.namedItem('graf').value;		grafString=grafString.trim().toLowerCase();		if(grafString=="/birthdays"||grafString=="/bdays") {			showTodaysBirthdays();				theForm.elements.namedItem('graf').value="";				e.preventDefault();				e.stopPropagation();		}	}}function preventEnter(e) {	if(e.target == graf) {		var theForm = document.getElementsByTagName('form')[0];		var grafString = theForm.elements.namedItem('graf').value;		if (e.keyCode==13) {			if(grafString=="/birthdays"||grafString=="/bdays") {				showTodaysBirthdays();				theForm.elements.namedItem('graf').value="";				e.preventDefault();				e.stopPropagation();			}		}	}}function chatBirthdays() {		var theForm = document.getElementsByTagName('form')[0];	submitButton = find('.//input[@value="Chat" and @onclick]',theForm);	if(submitButton) {		theForm.addEventListener('click',submitFormRedirect,true);	}	graf = find('.//input[@name="graf"]',theForm);	if(graf) {		theForm.addEventListener('keyup',preventEnter,true);	}			var d = new Date();	var n = new Date();		var monthName = months[d.getMonth()];	dateString = monthName+' '+d.getDate();	todaysBirthdays = birthdays[dateString];	todaysBirthdayIds=new Array();	for(var i=0,l=todaysBirthdays.length;i<l;i++) {		todaysBirthdayIds.push(todaysBirthdays[i][0]);	}		window.setInterval(readWindow,8000);	readWindow(birthdays[dateString]);	n.setDate(n.getDate()+1);	n.setHours(0);	n.setMinutes(0);	var when=n-d;	window.setTimeout(clearWindow,when);}function clearWindow() {	var d = new Date();	var monthName = months[d.getMonth()];	var newDateString = monthName+' '+d.getDate();	if(newDateString!=dateString) {		var pattern = './/a[@birthday]';		var links = document.evaluate(pattern, document, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );		if(links.snapshotLength) {			for ( var i=0 ; i < links.snapshotLength; i++ ) {				links.snapshotItem(i).removeAttribute('birthday');			}		}		dateString = newDateString;		todaysBirthdays = birthdays[dateString];		todaysBirthdayIds.length=0;		for(var i=0,l=todaysBirthdays.length;i<l;i++) {			todaysBirthdayIds.push(todaysBirthdays[i][0]);		}	}}function readWindow() {	var ar=todaysBirthdayIds;	string='@href="showplayer.php?who='+ar.join('" or @href="showplayer.php?who=')+'"';	var pattern = './/a[('+string+') and not(@birthday)]';	var links = document.evaluate(pattern, document, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null );	if(links.snapshotLength) {		for ( var i=0 ; i < links.snapshotLength; i++ ) {			links.snapshotItem(i).setAttribute('birthday',true);		}	}}function GM_get( dest, callback, external){	var theHost = (external)?"":document.location.host;	GM_xmlhttpRequest({		method: 'GET',		url: 'http://'+ theHost + dest,		onload:function(details) {			if( typeof callback=='function' ){				callback(details.responseText);			}		}	});}String.prototype.trim = function()  {	return this.replace(/^\s+|\s+$/g,"");}